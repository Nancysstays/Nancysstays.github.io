<!DOCTYPE html>
<html>
<head>
  <title>GitHub Repo Explorer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .dropdown-menu {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<div class="container mt-5">
  <h1>GitHub Repo Explorer</h1>
  <div class="input-group mb-3">
    <input type="text" class="form-control" id="searchInput" placeholder="Enter GitHub username or repo">
    <button class="btn btn-outline-secondary" type="button" id="searchButton">
      <i class="fas fa-search"></i>
    </button>
  </div>

  <div class="list-group" id="repoList"></div>

  <div id="editorContainer" style="display: none;">
    <textarea id="editor" rows="20" cols="80"></textarea>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.3/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.3/mode/meta.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.63.3/keymap/vim.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.63.3/lib/codemirror.min.css">

<script>
  const searchInput = document.getElementById('searchInput');
  const searchButton = document.getElementById('searchButton');
  const repoList = document.getElementById('repoList');
  const editorContainer = document.getElementById('editorContainer');

  // Load previously entered users and search terms from localStorage
  let users = JSON.parse(localStorage.getItem('users')) || [];
  let searchHistory = JSON.parse(localStorage.getItem('searchHistory')) || [];

  // Autocomplete for usernames and search history
  searchInput.addEventListener('input', () => {
    const input = searchInput.value.toLowerCase();
    const filteredSuggestions = [
      ...users.filter(user => user.toLowerCase().includes(input)),
      ...searchHistory.filter(term => term.toLowerCase().includes(input))
    ];
    displayDropdown(filteredSuggestions);
  });

  // Display dropdown suggestions
  function displayDropdown(suggestions) {
    const dropdown = document.createElement('div');
    dropdown.classList.add('dropdown-menu');
    dropdown.setAttribute('aria-labelledby', 'searchInput');

    suggestions.forEach(suggestion => {
      const item = document.createElement('a');
      item.classList.add('dropdown-item');
      item.textContent = suggestion;
      item.addEventListener('click', () => {
        searchInput.value = suggestion;
        dropdown.remove();
        search(suggestion);
      });
      dropdown.appendChild(item);
    });

    searchInput.parentNode.appendChild(dropdown);
  }

  // Search for repositories or directly load a repo URL
  searchButton.addEventListener('click', () => {
    const searchTerm = searchInput.value;
    search(searchTerm);
  });

  function search(searchTerm) {
    // Add search term to localStorage
    if (!searchHistory.includes(searchTerm)) {
      searchHistory.push(searchTerm);
      localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
    }

    // Check if the search term is a valid URL
    if (isValidUrl(searchTerm)) {
      fetchRepoContents(searchTerm);
    } else {
      // Assume it's a username and search for repositories
      if (!users.includes(searchTerm)) {
        users.push(searchTerm);
        localStorage.setItem('users', JSON.stringify(users));
      }
      fetch(`https://api.github.com/users/${searchTerm}/repos`)
        .then(response => response.json())
        .then(repos => {
          displayRepos(repos);
        })
        .catch(error => {
          console.error('Error fetching repositories:', error);
          repoList.innerHTML = '<div class="alert alert-danger">Failed to fetch repositories.</div>';
        });
    }
  }

  // Display repositories in the list
  function displayRepos(repos) {
    repoList.innerHTML = ''; // Clear previous results

    if (repos.length === 0) {
      repoList.innerHTML = '<div class="alert alert-info">No repositories found.</div>';
      return;
    }

    repos.forEach(repo => {
      const repoItem = document.createElement('a');
      repoItem.classList.add('list-group-item', 'list-group-item-action');
      repoItem.href = repo.html_url;
      repoItem.textContent = repo.name;

      // Add event listener to fetch directories and files when clicking on a repo
      repoItem.addEventListener('click', (event) => {
        event.preventDefault(); // Prevent default link behavior
        fetchRepoContents(repo.html_url);
      });

      repoList.appendChild(repoItem);
    });
  }

  // Fetch directories and files within a repository
  function fetchRepoContents(repoUrl) {
    // Extract API URL from repo URL
    const apiUrl = repoUrl.replace('github.com', 'api.github.com/repos') + '/contents';

    fetch(apiUrl)
      .then(response => response.json())
      .then(contents => {
        displayRepoContents(contents);
      })
      .catch(error => {
        console.error('Error fetching repository contents:', error);
        repoList.innerHTML = '<div class="alert alert-danger">Failed to fetch repository contents.</div>';
      });
  }

  // Display directories and files within a repository
  function displayRepoContents(contents) {
    repoList.innerHTML = ''; // Clear previous results

    contents.forEach(item => {
      const itemElement = document.createElement('div');
      itemElement.classList.add('list-group-item', 'list-group-item-action');
      itemElement.textContent = item.name;

      if (item.type === 'dir') {
        // If it's a directory, add an icon and event listener to fetch its contents
        itemElement.innerHTML = '<i class="fas fa-folder mr-2"></i>' + item.name;
        itemElement.addEventListener('click', (event) => {
          event.preventDefault();
          fetchRepoContents(item.url);
        });
      } else {
        // If it's a file, display it in the editor
        itemElement.addEventListener('click', (event) => {
          event.preventDefault();
          displayFile(item.html_url, item.name);
        });
      }

      repoList.appendChild(itemElement);
    });
  }

  // Display a file in the CodeMirror editor
  function displayFile(fileUrl, fileName) {
    // Show the editor container
    editorContainer.style.display = 'block';

    // Create CodeMirror editor instance
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
      lineNumbers: true,
      mode: getMode(fileName),
      keyMap: "vim", // Use Vim keybindings
      theme: "default"
    });

    // Fetch the file content and display it in the editor
    fetch(fileUrl)
      .then(response => response.text())
      .then(content => {
        editor.setValue(content);
      })
      .catch(error => {
        console.error('Error fetching file content:', error);
        editor.setValue("Error loading file content.");
      });
  }

  // Helper function to get CodeMirror mode based on file extension
  function getMode(fileName) {
    const fileExtension = fileName.split('.').pop().toLowerCase();
    switch (fileExtension) {
      case "html": return "htmlmixed";
      case "css": return "css";
      case "js": return "javascript";
      case "json": return "javascript";
      // Add more cases for other file types as needed
      default: return "text/plain";
    }
  }

  // Helper function to check if a string is a valid URL
  function isValidUrl(string) {
    try {
      new URL(string);
      return true;
    } catch (err) {
      return false;
    }
  }
</script>

</body>
</html>
