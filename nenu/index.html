<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Menus with Multiple Storage & Gemini AI</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      font-family: sans-serif;
    }

    .link-iframe {
      width: 100%;
      height: 200px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }

    #gemini-response {
      white-space: pre-wrap; /* Preserve line breaks in Gemini response */
    }
  </style>
</head>

<body>

<div class="container">
  <h1 class="mb-4">Dynamic Menus with AI-Powered Assistance</h1>

  <div id="saved-menus" class="mb-3"></div>

  <div class="form-group">
    <label for="menu-name">Menu Name:</label>
    <input type="text" id="menu-name" class="form-control" placeholder="Enter menu name">
  </div>

  <div class="input-group mb-3">
    <input type="text" id="new-link-name" class="form-control" placeholder="Link name">
    <input type="text" id="new-link-url" class="form-control" placeholder="Link URL">
    <input type="text" id="new-link-notes" class="form-control" placeholder="Notes (optional)">
    <div class="input-group-append">
      <button class="btn btn-primary" type="button" id="add-link">Add Link</button>
    </div>
  </div>

  <ul class="list-group" id="menu-list"></ul>

  <button class="btn btn-secondary mt-3" type="button" id="load-menu">Load Menu</button>
  <button class="btn btn-success mt-3" type="button" id="save-menu">Save Menu</button>

  <div class="mt-4">
    <h2>Ask Gemini for Help</h2>
    <p>Need ideas for links, help with notes, or just want to chat? Ask Gemini!</p>
    <textarea id="gemini-response" class="form-control mb-2" rows="8" readonly></textarea>
    <input type="text" id="gemini-question" class="form-control mb-2" placeholder="Enter your question">
    <button class="btn btn-info" type="button" id="ask-gemini">Ask Gemini</button>
  </div>

  <div class="mt-4">
    <h2>About This App</h2>
    <p>This app allows you to create and manage dynamic menus with links, notes, and timestamps.
      It utilizes multiple storage mechanisms (cache, localStorage, and IndexedDB) to persist your menus
      across sessions. You can also integrate with the Gemini AI API to get assistance with your menu
      creation and management.</p>
    <p>Features:</p>
    <ul>
      <li>Create, save, and load multiple menus</li>
      <li>Add, edit, and delete links with names, URLs, and notes</li>
      <li>View timestamps for link creation and last click</li>
      <li>Preview links in iframes</li>
      <li>Integrate with Gemini AI for assistance</li>
      <li>Persistent storage using cache, localStorage, and IndexedDB</li>
    </ul>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
<script>
  const menuList = document.getElementById('menu-list');
  const addLinkButton = document.getElementById('add-link');
  const newLinkNameInput = document.getElementById('new-link-name');
  const newLinkUrlInput = document.getElementById('new-link-url');
  const menuNameInput = document.getElementById('menu-name');
  const loadMenuButton = document.getElementById('load-menu');
  const saveMenuButton = document.getElementById('save-menu');
  const savedMenusDiv = document.getElementById('saved-menus');
  const geminiResponseTextArea = document.getElementById('gemini-response');
  const geminiQuestionInput = document.getElementById('gemini-question');
  const askGeminiButton = document.getElementById('ask-gemini');

  let db;

  // Open IndexedDB
  const request = window.indexedDB.open('menuDB', 1);

  request.onerror = function (event) {
    console.error('IndexedDB error:', event.target.errorCode);
  };

  request.onsuccess = function (event) {
    db = event.target.result;
    displaySavedMenuNames();
  };

  request.onupgradeneeded = function (event) {
    const db = event.target.result;
    db.createObjectStore('menus', {keyPath: 'name'});
  };

  // Function to display saved menu names
  function displaySavedMenuNames() {
    savedMenusDiv.innerHTML = '<strong>Saved Menus:</strong> ';

    const transaction = db.transaction(['menus'], 'readonly');
    const objectStore = transaction.objectStore('menus');
    const request = objectStore.getAllKeys();

    request.onsuccess = function (event) {
      const menuNames = event.target.result;
      if (menuNames.length === 0) {
        savedMenusDiv.innerHTML += ' None';
      } else {
        menuNames.forEach(name => {
          const menuSpan = document.createElement('span');
          menuSpan.classList.add('badge', 'badge-secondary', 'mr-2');
          menuSpan.textContent = name;
          menuSpan.addEventListener('click', () => {
            menuNameInput.value = name;
            loadMenu();
          });
          savedMenusDiv.appendChild(menuSpan);
        });
      }
    };
  }

  // Function to add a link to the menu list in the UI
  function addLinkToMenu(link) {
    const listItem = document.createElement('li');
    listItem.classList.add('list-group-item');

    // Add timestamp information to the link object if it doesn't exist
    if (!link.created) {
      link.created = new Date().toLocaleString();
    }
    if (!link.lastClicked) {
      link.lastClicked = "Never";
    }

    // Add notes to the link object if it doesn't exist
    if (!link.notes) {
      link.notes = "";
    }

    listItem.innerHTML = `
                <div>
                    <a href="${link.url}" target="_blank">${link.name}</a>
                    <div class="float-right">
                        <span class="badge badge-light mr-2">Created: ${link.created}</span>
                        <span class="badge badge-light mr-2">Last Clicked: ${link.lastClicked}</span>
                        <button class="btn btn-sm btn-warning edit-link">Edit</button>
                        <button class="btn btn-sm btn-danger delete-link">Delete</button>
                    </div>
                </div>
                <div class="link-notes">${link.notes}</div>
                <iframe class="link-iframe" src="${link.url}"></iframe>
            `;
    menuList.appendChild(listItem);

    // Add event listeners for edit and delete buttons
    const editButton = listItem.querySelector('.edit-link');
    const deleteButton = listItem.querySelector('.delete-link');
    const linkElement = listItem.querySelector('a');

    editButton.addEventListener('click', () => editLink(link, listItem));
    deleteButton.addEventListener('click', () => deleteLink(link));

    // Add event listener to update lastClicked timestamp
    linkElement.addEventListener('click', (event) => {
      event.preventDefault();
      link.lastClicked = new Date().toLocaleString();
      listItem.querySelector('.badge:nth-child(2)').textContent = "Last Clicked: " + link.lastClicked;
      window.open(link.url, '_blank');
    });
  }

  // Function to load menu data (from cache, localStorage, or IndexedDB)
  function loadMenu() {
    const menuName = menuNameInput.value;
    if (!menuName) {
      alert('Please enter a menu name.');
      return;
    }

    // Check cache first
    if (caches) {
      caches.open('menuCache').then(cache => {
        cache.match(menuName).then(response => {
          if (response) {
            response.json().then(menuData => {
              displayMenu(menuData, 'Cache');
            });
          } else {
            loadFromLocalStorageOrIndexedDB(menuName);
          }
        });
      });
    } else {
      loadFromLocalStorageOrIndexedDB(menuName);
    }
  }

  // Function to load from localStorage or IndexedDB
  function loadFromLocalStorageOrIndexedDB(menuName) {
    // Check localStorage
    const localStorageData = localStorage.getItem(menuName);
    if (localStorageData) {
      displayMenu(JSON.parse(localStorageData), 'LocalStorage');
    } else {
      // Load from IndexedDB
      const transaction = db.transaction(['menus'], 'readonly');
      const objectStore = transaction.objectStore('menus');
      const request = objectStore.get(menuName);

      request.onsuccess = function (event) {
        if (event.target.result) {
          displayMenu(event.target.result.links, 'IndexedDB'); // Access links property here
        } else {
          alert('Menu not found.');
        }
      };
    }
  }

  // Function to display the menu in the UI
  function displayMenu(menuData, source) {
    menuList.innerHTML = ''; // Clear the current list
    console.log('Menu loaded from:', source); // Log the source of the data
    menuData.forEach(link => addLinkToMenu(link));
  }

  // Function to save the menu (to cache, localStorage, and IndexedDB)
  function saveMenu() {
    const menuName = menuNameInput.value;
    if (!menuName) {
      alert('Please enter a menu name.');
      return;
    }

    const links = [];
    menuList.querySelectorAll('li').forEach(item => {
      const linkElement = item.querySelector('a');
      const created = item.querySelector('.badge:nth-child(1)').textContent.split(': ')[1];
      const lastClicked = item.querySelector('.badge:nth-child(2)').textContent.split(': ')[1];
      const notes = item.querySelector('.link-notes').textContent;
      links.push({
        name: linkElement.textContent,
        url: linkElement.href,
        created: created,
        lastClicked: lastClicked,
        notes: notes
      });
    });

    // Save to cache
    if (caches) {
      caches.open('menuCache').then(cache => {
        cache.put(menuName, new Response(JSON.stringify(links)));
      });
    }

    // Save to localStorage
    localStorage.setItem(menuName, JSON.stringify(links));

    // Save to IndexedDB
    const transaction = db.transaction(['menus'], 'readwrite');
    const objectStore = transaction.objectStore('menus');
    const request = objectStore.put({name: menuName, links: links});

    request.onsuccess = function () {
      console.log('Menu saved successfully!');
      displaySavedMenuNames(); // Refresh the list of saved menus
    };
  }

  // Event listeners for loading and saving menus
  loadMenuButton.addEventListener('click', loadMenu);
  saveMenuButton.addEventListener('click', saveMenu);

  // Add new link
  addLinkButton.addEventListener('click', () => {
    const name = newLinkNameInput.value;
    const url = newLinkUrlInput.value;
    const notes = document.getElementById('new-link-notes').value;
    addLinkToMenu({name, url, notes});
    newLinkNameInput.value = '';
    newLinkUrlInput.value = '';
    document.getElementById('new-link-notes').value = '';
  });

  // Edit link
  function editLink(link, listItem) {
    const newName = prompt("Enter the new link name:", link.name);
    const newUrl = prompt("Enter the new link URL:", link.url);
    const newNotes = prompt("Enter new notes:", link.notes);
    if (newName && newUrl) {
      link.name = newName;
      link.url = newUrl;
      link.notes = newNotes;
      // Update the link in the UI
      const linkElement = listItem.querySelector('a');
      linkElement.textContent = newName;
      linkElement.href = newUrl;
      const notesDiv = listItem.querySelector('.link-notes');
      notesDiv.textContent = newNotes;
      const iframe = listItem.querySelector('.link-iframe');
      iframe.src = newUrl;
    }
  }

  // Delete link
  function deleteLink(link) {
    if (confirm(`Are you sure you want to delete "${link.name}"?`)) {
      // Remove the link from the UI
      const listItem = Array.from(menuList.querySelectorAll('li')).find(item => {
        const linkElement = item.querySelector('a');
        return linkElement.textContent === link.name && linkElement.href === link.url;
      });
      if (listItem) {
        menuList.removeChild(listItem);
      }
    }
  }


  askGeminiButton.addEventListener('click', () => {
    const userQuestion = geminiQuestionInput.value;
    if (userQuestion) {
      askGemini(userQuestion);
    }
  });

  function askGemini(question) {
    // Replace with your actual Gemini API call
    // This is a placeholder example using fetch
    fetch('https://api.gemini.com/v1/model/chat', { // Replace with the correct Gemini API endpoint
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer AIzaSyDiS4F6RE04oMW3BpURdHXXhbtOg3n65OA' // Replace with your actual API key
      },
      body: JSON.stringify({
        prompt: question
      })
    })
    .then(response => response.json())
    .then(data => {
      geminiResponseTextArea.value = data.response; // Assuming the response is in a 'response' field
    })
    .catch(error => {
      console.error('Error asking Gemini:', error);
      geminiResponseTextArea.value = "Error communicating with Gemini.";
    });
  }
</script>

</body>
</html>
