<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plotly Chart with Indicators</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="container mt-5">
    <div id="summary"></div> 
    <div id="price-chart"></div>
    <div id="indicator-chart"></div>
  </div>

  <script>
    const apiUrl = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=googl&apikey=XVYHOWRTRNPN3FJA'; // Replace with your actual API key

    async function fetchDataAndPlot() {
      let cachedData = localStorage.getItem('chartData');

      if (cachedData) {
        console.log('Using cached data');
        plotCharts(JSON.parse(cachedData));
      } else {
        console.log('Fetching data from API');
        try {
          const response = await fetch(apiUrl);
          const data = await response.json();

          localStorage.setItem('chartData', JSON.stringify(data));

          plotCharts(data);
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }
    }

    function plotCharts(data) {
      const dates = Object.keys(data['Time Series (Daily)']).reverse();
      const closingPrices = dates.map(date => parseFloat(data['Time Series (Daily)'][date]['4. close']));
      const highPrices = dates.map(date => parseFloat(data['Time Series (Daily)'][date]['2. high']));
      const lowPrices = dates.map(date => parseFloat(data['Time Series (Daily)'][date]['3. low']));

      // Calculate MACD
      const macd = calculateMACD(closingPrices);

      // Calculate ATR
      const atr = calculateATR(highPrices, lowPrices, closingPrices);

      // Calculate Stochastics
      const stoch = calculateStochastics(highPrices, lowPrices, closingPrices);

      // Determine buy/sell signal
      const signal = determineSignal(macd, atr, stoch);

      // Display buy/sell signal
      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = `<h2><span class="${signal === 'buy' ? 'text-success' : 'text-danger'}">${signal.toUpperCase()}</span></h2>`;

      // Price Chart
      const priceTrace = {
        x: dates,
        y: closingPrices,
        type: 'scatter',
        mode: 'lines',
        name: 'GOOGL Closing Price'
      };

      const priceLayout = {
        title: 'GOOGL Daily Closing Prices',
        xaxis: { title: 'Date' },
        yaxis: { title: 'Price' }
      };

      Plotly.newPlot('price-chart', [priceTrace], priceLayout);

      // Indicator Chart
      const macdTrace = {
        x: dates,
        y: macd.macd,
        type: 'scatter',
        mode: 'lines',
        name: 'MACD'
      };

      const signalTrace = {
        x: dates,
        y: macd.signal,
        type: 'scatter',
        mode: 'lines',
        name: 'Signal'
      };

      const histogramTrace = {
        x: dates,
        y: macd.histogram,
        type: 'bar',
        name: 'Histogram',
        marker: {
          color: macd.histogram.map(value => {
            if (value >= 0) {
              if (value >= 0.15) return '#006400'; // Dark green
              else if (value >= 0.1) return '#228B22'; // Forest green
              else if (value >= 0.05) return '#3CB371'; // Medium sea green
              else if (value >= 0.01) return '#7CFC00'; // Lawn green
              else return '#90EE90'; // Light green
            } else {
              if (value <= -0.15) return '#8B0000'; // Dark red
              else if (value <= -0.1) return '#B22222'; // Firebrick
              else if (value <= -0.05) return '#DC143C'; // Crimson
              else if (value <= -0.01) return '#FF0000'; // Red
              else return '#FFA07A'; // Light salmon
            }
          })
        }
      };

      const atrTrace = {
        x: dates,
        y: atr,
        type: 'scatter',
        mode: 'lines',
        name: 'ATR',
        yaxis: 'y2'
      };

      const stochKTrace = {
        x: dates,
        y: stoch.k,
        type: 'scatter',
        mode: 'lines',
        name: 'Stoch K',
        yaxis: 'y3'
      };

      const stochDTrace = {
        x: dates,
        y: stoch.d,
        type: 'scatter',
        mode: 'lines',
        name: 'Stoch D',
        yaxis: 'y3'
      };

      const indicatorLayout = {
        title: 'Indicators',
        xaxis: { title: 'Date' },
        yaxis: { title: 'MACD' },
        yaxis2: {
          title: 'ATR',
          overlaying: 'y',
          side: 'right'
        },
        yaxis3: {
          title: 'Stochastics',
          overlaying: 'y',
          side: 'right',
          position: 0.95
        }
      };

      Plotly.newPlot('indicator-chart', [macdTrace, signalTrace, histogramTrace, atrTrace, stochKTrace, stochDTrace], indicatorLayout);
    }

    function calculateMACD(closingPrices) {
      const fastPeriod = 12;
      const slowPeriod = 26;
      const signalPeriod = 9;

      const fastEMA = calculateEMA(closingPrices, fastPeriod);
      const slowEMA = calculateEMA(closingPrices, slowPeriod);
      const macdLine = fastEMA.map((value, index) => value - slowEMA[index]);
      const signalLine = calculateEMA(macdLine, signalPeriod);
      const histogram = macdLine.map((value, index) => value - signalLine[index]);

      return { macd: macdLine, signal: signalLine, histogram };
    }

    function calculateEMA(data, period) {
      const k = 2 / (period + 1);
      let ema = [data[0]];

      for (let i = 1; i < data.length; i++) {
        ema.push(data[i] * k + ema[i - 1] * (1 - k));
      }

      return ema;
    }

    function calculateATR(highPrices, lowPrices, closingPrices) {
      let trueRange = [];
      for (let i = 1; i < closingPrices.length; i++) {
        trueRange.push(Math.max(
          highPrices[i] - lowPrices[i],
          Math.abs(highPrices[i] - closingPrices[i - 1]),
          Math.abs(lowPrices[i] - closingPrices[i - 1])
        ));
      }

      const atrPeriod = 14;
      return calculateEMA(trueRange, atrPeriod);
    }

    function calculateStochastics(highPrices, lowPrices, closingPrices) {
      const kPeriod = 14;
      const dPeriod = 3;

      let kValues = [];
      for (let i = kPeriod - 1; i < closingPrices.length; i++) {
        const highestHigh = Math.max(...highPrices.slice(i - kPeriod + 1, i + 1));
        const lowestLow = Math.min(...lowPrices.slice(i - kPeriod + 1, i + 1));
        kValues.push(100 * (closingPrices[i] - lowestLow) / (highestHigh - lowestLow));
      }

      const dValues = calculateEMA(kValues, dPeriod);

      return { k: kValues, d: dValues };
    }

    function determineSignal(macd, atr, stoch) {
      // Implement your buy/sell logic here based on the indicators
      // This is a simple example, you should adjust it to your needs
      const lastMacd = macd.histogram[macd.histogram.length - 1];
      const lastStochK = stoch.k[stoch.k.length - 1];
      const lastStochD = stoch.d[stoch.d.length - 1];

      if (lastMacd > 0 && lastStochK > lastStochD && lastStochK < 80) {
        return 'buy';
      } else if (lastMacd < 0 && lastStochK < lastStochD && lastStochK > 20) {
        return 'sell';
      } else {
        return 'hold'; 
      }
    }

    fetchDataAndPlot();
  </script>
</body>
</html>
